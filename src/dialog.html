<button class="btn btn-primary btn-select-multiple-media js-select-multiple-media">Lägg till bilder</button>
<div class="js-items items"></div>
<script>
  function appStart(extension) {
    var dialogButtonMultipleMedia = document.querySelector('.js-select-multiple-media');
    var jsItems = document.querySelector('.js-items');
    var currentItems = extension.field.getValue() || { data : [] };

    dialogButtonMultipleMedia.addEventListener('click', function(e) {
      extension.dialogs.selectMultipleMedia()
        .then(function(items) {
          if (!items) return;
          currentItems.data = currentItems.data.concat(items.data);
          renderTemplate(currentItems);
          extension.field.setValue(currentItems);
        })
    });

    function renderTemplate(items) {
      var str = '';
      if (items.data.length) {
        getItems(items, function (items) {
          str += '<div class="well well--items">';
          str += '<div class="row">';
          items.data.map(function(item) {
          str += '  <div class="js-item item col-xs-6 col-sm-4 col-md-3 col-lg-2" data-id="' + item.id + '">';
          str += '    <div class="btn-group" role="group">';
          str += '      <button type="button" class="btn btn-default js-move btn-move">Move</button>';
          str += '      <button type="button" class="btn btn-default js-edit btn-edit">Edit</button>';
          str += '      <button type="button" class="btn btn-default js-delete btn-delete">Delete</button>';
          str += '    </div>';
          str += '    <a href="#" class="thumbnail">';
          str += '      <img class="js-edit-image" style="height: 120px;" src="' + item.attributes.file.url + '" alt="' + item.attributes.title + '"/>';
          str += '    </a>';
          str += '  </div>';
          });
          str += '</div>'; 
          str += '</div>';
          jsItems.innerHTML = str;
          setTemplateEvents()
          extension.window.updateHeight();
        });
      } else {
        str += '<div class="well well-lg text-center well--empty">';
        str += '  <div class="fa fa-image icon"></div>';
        str += '  <div class="text">';
        str += '    Inga bilder ännu.<br />Klicka på knappen ovan för att lägga till bilder!';
        str += '  </div>';
        str += '</div>';
        jsItems.innerHTML = str;
        extension.window.updateHeight();
      }
    }

    function setTemplateEvents() {
      var items = document.querySelectorAll('.js-items .js-item');
      [].forEach.call(items, function(item) {
        var editButton = item.querySelector('.js-edit');
        var editImage = item.querySelector('.js-edit-image');
        var deleteButton = item.querySelector('.js-delete');
        var id = editButton.parentNode.parentNode.getAttribute('data-id');
        editButton.addEventListener('click', function (e) {
          editItem(id);
        }, false); 
        editImage.addEventListener('click', function (e) {
          editItem(id);
        }, false); 
        deleteButton.addEventListener('click', function (e) {
          deleteItem(id);
        }, false); 
      });
    }

    function getItems(items, cb) {
      var ids = items.data.map(function(item) {
        return item.id;
      }).join();
      extension.bucket.get('media', {'id[eq]': ids})
        .then(function(items) {
          cb(items);
        })
    }

    function editItem(id) {
      extension.dialogs.selectSingleMedia()
        .then(function(res) {
          console.log(res);
        })
        .catch(function(err) {
          console.log(err);
        });
    }

    function deleteItem(id) {
      currentItems.data = currentItems.data.filter(function(item) {
        return item.id !== id;
      });
      renderTemplate(currentItems);
      extension.field.setValue(currentItems);
    }

    renderTemplate(currentItems);
    extension.window.updateHeight();
  }

  twixly.extension.init({ enableDefault: ['*'] })
    .then(appStart)
    .catch(function (err) {
      console.log(err);
    });
</script>